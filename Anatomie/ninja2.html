<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WarioWare QCM — Timer propre + musique</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --bg: #0f1720;
      --card: #141824;
      --accent: #0dcaf0;
      --ok: #1fa44a;
      --bad: #ff5c5c;
    }
    body {
      background: linear-gradient(180deg,#071025 0%, #091426 80%);
      color: #eef6fb;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      margin: 0;
      padding: 24px;
      -webkit-font-smoothing:antialiased;
    }

    .wrap {
      max-width: 760px;
      margin: 0 auto;
    }

    .card-game {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
    }

    h1 { font-size: 1.2rem; margin-bottom: 0; }
    .sub { color: #9fb9c8; font-size: .95rem; }

    /* timer */
    .timer-outer {
      height: 14px;
      background: rgba(255,255,255,0.04);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.03);
    }
    .timer-inner {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, var(--accent), #60e0ff);
      transform-origin: left center;
      transition: width linear;
    }

    /* pause overlay */
    #pauseOverlay {
      display:none;
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.85);
      color: white;
      z-index: 9999;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      pointer-events: none;
    }
    #pauseOverlay.show { display:flex; pointer-events: auto; animation: pulse 1s linear; }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.12); opacity: 1; }
      100% { transform: scale(1); opacity: 0.9; }
    }

    /* choices */
    .choice-btn { text-align: left; font-weight:600; }
    .choice-btn:focus { outline: none; box-shadow: 0 6px 18px rgba(0,0,0,0.6); }

    /* feedback */
    .feedback {
      min-height: 36px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 8px;
      padding: 6px 10px;
      font-weight:700;
      margin-top: 12px;
    }
    .feedback.ok { color: var(--ok); background: rgba(31,164,74,0.08); border:1px solid rgba(31,164,74,0.08); }
    .feedback.bad { color: var(--bad); background: rgba(255,92,92,0.06); border:1px solid rgba(255,92,92,0.06); }

    .meta { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .hearts { font-size:1.1rem; }
    .score { font-weight:700; }

    /* gameover */
    #gameOverBox { display:none; text-align:center; }

    @media (max-width:600px){
      .choice-btn { font-size: .95rem; padding: .6rem .75rem; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h1>WarioWare — QCM Express</h1>
        <div class="sub">Réponds vite — le temps peut changer par question. Pause animée entre chaque question.</div>
      </div>
      <div class="text-end">
        <div class="score" id="scoreDisplay">Score: 0</div>
        <div class="text-muted small">Vies : <span id="livesDisplay">3</span></div>
      </div>
    </div>

    <div class="card-game">
      <div class="meta mb-3">
        <div style="flex:1;">
          <div class="d-flex justify-content-between mb-1">
            <small class="text-muted">Temps restant</small>
            <small id="timeText" class="text-muted">--ms</small>
          </div>
          <div class="timer-outer">
            <div id="timerBar" class="timer-inner" style="width:100%"></div>
          </div>
        </div>
        <div style="min-width:130px; text-align:right;">
          <div class="text-muted small">Question</div>
          <div id="questionIndex" style="font-weight:700">0 / 0</div>
        </div>
      </div>

      <div id="questionBox" class="mb-3">
        <div id="questionText" style="font-size:1.25rem; font-weight:700;">...</div>
      </div>

      <div id="choices" class="d-grid gap-2 mb-2"></div>

      <div id="feedback" class="feedback"></div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <button id="startBtn" class="btn btn-success">Démarrer</button>
        <div class="text-muted small">Vitesse initiale (ms)</div>
        <input id="speedInput" type="range" min="1200" max="7000" value="4000" style="width:180px;">
        <button id="pauseBtn" class="btn btn-outline-light">Pause</button>
      </div>

      <div id="gameOverBox" class="mt-4">
        <h3 class="text-warning">GAME OVER</h3>
        <div id="finalScore" class="fs-4 fw-bold mb-3"></div>
        <button id="restartBtn" class="btn btn-primary">Rejouer</button>
      </div>

    </div>
  </div>

  <div id="pauseOverlay">⚡</div>

  <!-- Sons -->
  <audio id="bgMusic" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" loop></audio>
  <audio id="sfxRight" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="sfxWrong" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <script>
  // -------------------------
  // CONFIG / QUESTIONS
  // -------------------------
  // chaque question peut définir un champ timeMs (durée de la barre en ms)
  const QUESTIONS = [
    { q: "Quel organe produit la bile ?", choices: ["Poumon","Foie","Rein","Estomac"], correct: "Foie", timeMs: 3800 },
    { q: "Combien d'os a le squelette adulte approximativement ?", choices: ["206","305","180","220"], correct: "206", timeMs: 4500 },
    { q: "Où ont lieu les échanges gazeux ?", choices: ["Poumon","Cœur","Foie","Rate"], correct: "Poumon", timeMs: 3200 },
    { q: "Quel plexus innerve le membre supérieur ?", choices: ["Lombaire","Sacré","Brachial","Coccygien"], correct: "Brachial", timeMs: 3600 },
    { q: "Quel organe régule la glycémie ?", choices: ["Rein","Pancréas","Rate","Estomac"], correct: "Pancréas", timeMs: 3400 }
  ];

  // -------------------------
  // ÉTAT
  // -------------------------
  let currentIdx = 0;          // index dans QUESTIONS sequence (we will randomize each pick)
  let currentQ = null;        // current question object
  let score = 0;
  let lives = 3;
  let running = false;
  let timerTimeout = null;    // setTimeout handle for end of timer
  let timerInterval = null;   // interval for ms display
  let questionStartTime = 0;
  let currentDuration = 4000; // current question duration (ms)
  let musicRate = 1.0;

  // DOM elems
  const timerBar = document.getElementById('timerBar');
  const timeText = document.getElementById('timeText');
  const questionText = document.getElementById('questionText');
  const choicesDiv = document.getElementById('choices');
  const feedbackEl = document.getElementById('feedback');
  const scoreDisplay = document.getElementById('scoreDisplay');
  const livesDisplay = document.getElementById('livesDisplay');
  const questionIndex = document.getElementById('questionIndex');
  const pauseOverlay = document.getElementById('pauseOverlay');
  const bgMusic = document.getElementById('bgMusic');
  const sfxRight = document.getElementById('sfxRight');
  const sfxWrong = document.getElementById('sfxWrong');

  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const speedInput = document.getElementById('speedInput');
  const restartBtn = document.getElementById('restartBtn');

  // -------------------------
  // UTIL: pick a random question (no strict sequence)
  // -------------------------
  function pickRandomQuestion() {
    const i = Math.floor(Math.random() * QUESTIONS.length);
    return QUESTIONS[i];
  }

  // -------------------------
  // UI updates
  // -------------------------
  function updateMetaUI() {
    scoreDisplay.textContent = "Score: " + score;
    livesDisplay.textContent = lives;
    questionIndex.textContent = `${currentIdx} / ∞`;
  }

  // -------------------------
  // TIMER: reset + reflow technique
  // startTimer(durationMs) returns a promise resolved on timeout
  // -------------------------
  function startTimer(durationMs) {
    clearTimer();

    // reset
    timerBar.style.transition = 'none';
    timerBar.style.width = '100%';

    // force reflow to ensure transition restarts
    // eslint-disable-next-line no-unused-expressions
    timerBar.offsetHeight;

    // apply transition for duration
    timerBar.style.transition = `width ${durationMs}ms linear`;
    // small delay for smooth effect
    setTimeout(() => timerBar.style.width = '0%', 10);

    // update ms left text with interval
    const start = Date.now();
    timerInterval = setInterval(() => {
      const elapsed = Date.now() - start;
      const left = Math.max(0, Math.round(durationMs - elapsed));
      timeText.textContent = left + ' ms';
    }, 60);

    // return a promise that resolves when timer ends
    return new Promise(resolve => {
      timerTimeout = setTimeout(() => {
        clearTimer();
        resolve();
      }, durationMs);
    });
  }

  function clearTimer() {
    if (timerTimeout) { clearTimeout(timerTimeout); timerTimeout = null; }
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  }

  // -------------------------
  // Show pause overlay for 1s then call cb
  // -------------------------
  function showPauseThen(cb) {
    pauseOverlay.classList.add('show');
    setTimeout(() => {
      pauseOverlay.classList.remove('show');
      cb();
    }, 1000);
  }

  // -------------------------
  // load and display a question
  // -------------------------
  async function loadNextQuestion() {
    if (!running) return;
    if (lives <= 0) return endGame();

    // show animated pause then the question
    showPauseThen(async () => {
      currentQ = pickRandomQuestion();
      currentIdx++;
      questionText.textContent = currentQ.q;
      feedbackEl.className = 'feedback';
      feedbackEl.textContent = '';

      // shuffle choices
      const shuffled = [...currentQ.choices].sort(() => Math.random() - 0.5);

      // render buttons
      choicesDiv.innerHTML = '';
      shuffled.forEach(choice => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-lg btn-outline-light choice-btn';
        btn.textContent = choice;
        btn.onclick = () => onChoiceClick(choice);
        choicesDiv.appendChild(btn);
      });

      // set current duration (question-specific or from slider)
      const base = parseInt(speedInput.value, 10) || 4000;
      currentDuration = currentQ.timeMs ?? base;

      // start timer (await its completion)
      try {
        await startTimer(currentDuration);
        // If timer resolves (no answer clicked), treat as timeout
        // but ensure running state
        if (running) onTimeout();
      } catch (e) {
        // ignore
      }
    });
  }

  // -------------------------
  // handle click on choice
  // -------------------------
  function onChoiceClick(choice) {
    if (!running) return;
    // prevent double click by disabling all buttons immediately
    [...choicesDiv.querySelectorAll('button')].forEach(b => b.disabled = true);

    // stop timer
    clearTimer();

    const correct = currentQ.correct;
    if (String(choice).toLowerCase() === String(correct).toLowerCase()) {
      // correct
      score += 1;
      feedbackEl.className = 'feedback ok';
      feedbackEl.textContent = '✅ Correct !';
      sfxRight.currentTime = 0; sfxRight.play().catch(()=>{});
      // accelerate music slightly
      musicRate = Math.min(2.4, musicRate + 0.06);
      bgMusic.playbackRate = musicRate;
      // pause 1s then next
      updateMetaUI();
      setTimeout(() => { if (running) loadNextQuestion(); }, 1000);
    } else {
      // wrong
      lives -= 1;
      feedbackEl.className = 'feedback bad';
      feedbackEl.textContent = '❌ Faux !';
      sfxWrong.currentTime = 0; sfxWrong.play().catch(()=>{});
      // small deceleration
      musicRate = Math.max(0.6, musicRate - 0.03);
      bgMusic.playbackRate = musicRate;
      updateMetaUI();
      if (lives <= 0) return endGame();
      setTimeout(() => { if (running) loadNextQuestion(); }, 1000);
    }
  }

  // -------------------------
  // timeout handler
  // -------------------------
  function onTimeout() {
    // disable buttons
    [...choicesDiv.querySelectorAll('button')].forEach(b => b.disabled = true);
    lives -= 1;
    feedbackEl.className = 'feedback bad';
    feedbackEl.textContent = '⌛ Trop lent !';
    sfxWrong.currentTime = 0; sfxWrong.play().catch(()=>{});
    // slow music a bit
    musicRate = Math.max(0.6, musicRate - 0.03);
    bgMusic.playbackRate = musicRate;
    updateMetaUI();
    if (lives <= 0) return endGame();
    setTimeout(() => { if (running) loadNextQuestion(); }, 1000);
  }

  // -------------------------
  // end game
  // -------------------------
  function endGame() {
    running = false;
    clearTimer();
    // hide main area, show game over
    document.getElementById('gameOverBox').style.display = 'block';
    document.getElementById('finalScore').textContent = `Score final : ${score}`;
    bgMusic.pause();
  }

  // -------------------------
  // start / pause / restart handlers
  // -------------------------
  startBtn.addEventListener('click', () => {
    if (running) return;
    running = true;
    score = 0;
    lives = 3;
    currentIdx = 0;
    musicRate = 1.0;
    bgMusic.currentTime = 0;
    bgMusic.playbackRate = musicRate;
    bgMusic.volume = 0.25;
    bgMusic.play().catch(()=>{});
    updateMetaUI();
    document.getElementById('gameOverBox').style.display = 'none';
    loadNextQuestion();
  });

  pauseBtn.addEventListener('click', () => {
    if (!running) return;
    // toggles pause/resume
    if (bgMusic.paused) {
      bgMusic.play().catch(()=>{});
      running = true;
      loadNextQuestion();
      pauseBtn.textContent = 'Pause';
    } else {
      bgMusic.pause();
      running = false;
      clearTimer();
      pauseBtn.textContent = 'Reprendre';
      feedbackEl.className = 'feedback';
      feedbackEl.textContent = '⏸️ En pause';
    }
  });

  restartBtn.addEventListener('click', () => {
    document.getElementById('gameOverBox').style.display = 'none';
    running = false;
    startBtn.click();
  });

  // init UI
  updateMetaUI();
  feedbackEl.textContent = 'Appuie sur Démarrer pour jouer';
  timeText.textContent = '-- ms';
  // do not auto-start music until user starts (browsers block autoplay)
  bgMusic.volume = 0.18;
  bgMusic.playbackRate = musicRate;

  </script>
</body>
</html>
